175.Combine Two Tables
https://leetcode.com/problems/combine-two-tables/

select p.firstname, p.lastname, a.city, a.state
from person p left join address a
on p.personid = a.personid

176. Second Highest Salary
https://leetcode.com/problems/second-highest-salary/

select (
    select distinct salary 
    from employee e 
    where 1= (select count(distinct salary) 
              from employee where e.salary < salary)

) as SecondHighestSalary

177. Nth Highest Salary
https://leetcode.com/problems/nth-highest-salary/

CREATE FUNCTION getNthHighestSalary(N INT) RETURNS INT
BEGIN
  RETURN (
      # Write your MySQL query statement below.
      select distinct salary from employee e where N-1=
      (select count(distinct salary) from employee where e.salary < salary)
  );
END

178. Rank Scores
https://leetcode.com/problems/rank-scores/

select score, dense_rank() over(order by score desc) as 'Rank' 
from scores

180. Consecutive Numbers
https://leetcode.com/problems/consecutive-numbers/

select distinct a1.num as ConsecutiveNums
from logs a1 join logs a2 
on a1.id = a2.id-1 and a1.num=a2.num
join logs a3 
on a2.id = a3.id-1 and a2.num = a3.num

181. Employees Earning More Than Their Managers
https://leetcode.com/problems/employees-earning-more-than-their-managers/

select e1.name as employee
from employee e1 inner join employee e2
on e1.managerid = e2.id
where e1.salary > e2.salary

182. Duplicate Emails
https://leetcode.com/problems/duplicate-emails/
select email from person group by email having count(*) > 1

183. Customers Who Never Order
https://leetcode.com/problems/customers-who-never-order/

select name as Customers from customers
where id not in (select customerid from orders)

select c.name as customers
from customers c left join orders o
on c.id = o.CustomerId
where o.CustomerId is null

184. Department Highest Salary
https://leetcode.com/problems/department-highest-salary/

select d.name as department, e.name as employee, e.salary
from employee e join department d
on e.departmentid = d.id
where (e.departmentid,e.salary)
in
(select departmentid, max(salary) ms
from employee
group by departmentid)

185. Department Top Three Salaries
https://leetcode.com/problems/department-top-three-salaries/

select d.name as department, e.name as employee, e.salary
from employee e join department d
on e.departmentid = d.id
where 2 >=(select count(distinct salary) from employee where e.salary <salary and e.departmentid = departmentid)

select d.name as department, e.name as employee, e.salary
from 
(select *, dense_rank() over(partition by departmentid order by salary desc) as rnk
 from employee) e 
join department d
on e.DepartmentId = d.id
where e.rnk <=3

196. Delete Duplicate Emails
https://leetcode.com/problems/delete-duplicate-emails/

delete p1 from
person p1 join person p2
on p1.email = p2.email
where p1.id > p2.id

197. Rising Temperature
https://leetcode.com/problems/rising-temperature/

select w2.id
from weather w1
join weather w2
on to_days(w1.recorddate)+1 = to_days(w2.recorddate)
where w2.temperature > w1.temperature

262. Trips and Users
https://leetcode.com/problems/trips-and-users/

select request_at as day, 
round(sum(case when status like 'cancelled%' then 1 else 0 end )/count(*),2) as "Cancellation Rate"
from trips
where client_id not in 
(select users_id
 from users 
 where banned='Yes')
and driver_id not in
(select users_id
 from users 
 where banned='Yes')
and request_at between '2013-10-01' and '2013-10-03'
 group by request_at
 

511. Game Play Analysis I
https://leetcode.com/problems/game-play-analysis-i/
512. Game Play Analysis II
https://leetcode.com/problems/game-play-analysis-ii/
534. Game Play Analysis III
https://leetcode.com/problems/game-play-analysis-iii/
550. Game Play Analysis IV
https://leetcode.com/problems/game-play-analysis-iv/
1097. Game Play Analysis V
https://leetcode.com/problems/game-play-analysis-v/

DDL
drop table Activity;
Create table Activity (player_id int, device_id int, event_date date, games_played int);
insert into Activity (player_id, device_id, event_date, games_played) values (1, 2, to_date('2016-03-01','YYYY-MM-DD'), 5);
insert into Activity (player_id, device_id, event_date, games_played) values (1, 2, to_date('2016-03-02','YYYY-MM-DD'), 6);
insert into Activity (player_id, device_id, event_date, games_played) values (2, 3, to_date('2017-06-25','YYYY-MM-DD'), 1);
insert into Activity (player_id, device_id, event_date, games_played) values (3, 1, to_date('2016-03-01','YYYY-MM-DD'), 0);
insert into Activity (player_id, device_id, event_date, games_played) values (3, 4, to_date('2018-07-31','YYYY-MM-DD'), 5);

511. Game Play Analysis I
select player_id, min(event_date) first_login from activity group by player_id

512. Game Play Analysis II
select player_id, device_id
from Activity 
where (player_id, event_date) in 
(select player_id, min(event_date) md
from Activity 
 group by player_id)
 
select player_id, device_id
from(
select player_id, device_id, rank() over(partition by player_id order by event_date) as rnk
from activity) a
where rnk=1
 
534. Game Play Analysis III
select  a2.player_id, a2.event_date, sum(a1.games_played) games_played_so_far 
from Activity a1 inner join Activity a2
on a1.player_id = a2.player_id and a1.event_date <= a2.event_date
group by a2.player_id, a2.event_date
order by a2.player_id,a2.event_date;

550. Game Play Analysis IV
select round(count(distinct a2.player_id)/count(distinct a1.player_id),2) fraction  
from
(select player_id, min(event_date) first_login from Activity group by player_id) a1
left join
Activity a2
on a1.first_login + 1 = a2.event_date
and a1.player_id = a2.player_id

569. Median Employee Salary
https://leetcode.com/problems/median-employee-salary/

with t1 as(
select *, row_number() over(partition by Company order by Salary) as rnk,
count(Id) over(partition by Company) as cnt
from Employee )

select Id, Company, Salary
from t1
where rnk between cnt/2 and cnt/2+1;

570. Managers with at Least 5 Direct Reports
https://leetcode.com/problems/managers-with-at-least-5-direct-reports/

select e.name
from
(select managerid
from employee
group by managerid
having count(id) >=5) a join employee e
on a.managerid = e.id

571. Find Median Given Frequency of Numbers
https://leetcode.com/problems/find-median-given-frequency-of-numbers/

select avg(n.number) as median 
from numbers n
where n.frequency >= abs((select sum(frequency) from numbers where n.number >= number) -
(select sum(frequency) from numbers where n.number <= number))

574. Winning Candidate
https://leetcode.com/problems/winning-candidate/

select Name from Candidate where id = (select candidateid from Vote group by candidateid order by count(candidateid) desc limit 1)

577. Employee Bonus
https://leetcode.com/problems/employee-bonus/

select e.name, b.bonus
from employee e
left join bonus b
on e.empid = b.empid
where b.bonus < 1000 or b.bonus is null

578. Get Highest Answer Rate Question
https://leetcode.com/problems/get-highest-answer-rate-question/

with tmp as (
select
    question_id,
    sum(case when answer_id is not Null then 1 else 0 end) / count(*) as rate
from survey_log
group by question_id)

select
question_id as survey_log
from tmp
where rate in (select max(rate) from tmp)

579. Find Cumulative Salary of an Employee
https://leetcode.com/problems/find-cumulative-salary-of-an-employee/

select a.id, a.month, a.salary from

(select id, month, sum(salary) over (partition by id order by month rows between 2 preceding and 0 following) as Salary, rank() over (partition by id order by month desc) as rank from Employee) a

where a.rank !=1 order by a.id, a.month desc

SELECT   A.Id, MAX(B.Month) as Month, SUM(B.Salary) as Salary
FROM     Employee A, Employee B
WHERE    A.Id = B.Id AND B.Month BETWEEN (A.Month-3) AND (A.Month-1)
GROUP BY A.Id, A.Month
ORDER BY Id, Month DESC

580. Count Student Number in Departments
https://leetcode.com/problems/count-student-number-in-departments/

select d.dept_name, count(s.student_id) as student_number
from student s
right join department d
on s.dept_id = d.dept_id
group by d.dept_id
order by student_number desc, d.dept_name

584. Find Customer Referee
https://leetcode.com/problems/find-customer-referee/

select name from customer
where referee_id != 2 or referee_id is null

585. Investments in 2016
https://leetcode.com/problems/investments-in-2016/

select sum(a.tiv_2016) as TIV_2016
from insurance a
where a.tiv_2015 in 
(select tiv_2015 
 from insurance
group by tiv_2015
having count(pid)>1)
and (a.lat,a.lon) in 
(select lat, lon
from insurance
group by concat(lat,',',lon)
having count(pid)=1)

586. Customer Placing the Largest Number of Orders
https://leetcode.com/problems/customer-placing-the-largest-number-of-orders/

select customer_number
from orders
group by customer_number
order by count(order_number) desc limit 1
follow-up
SELECT customer_number
FROM orders
GROUP BY customer_number
HAVING COUNT(order_number) = (
	SELECT COUNT(order_number) cnt
	FROM orders
	GROUP BY customer_number
	ORDER BY cnt DESC
	LIMIT 1
)

595. Big Countries
https://leetcode.com/problems/big-countries/

select name,population, area
from world
where area > 3000000 or population > 25000000

596. Classes More Than 5 Students
https://leetcode.com/problems/classes-more-than-5-students/

select class
from courses
group by class
having count(distinct student)>=5

597. Friend Requests I: Overall Acceptance Rate
https://leetcode.com/problems/friend-requests-i-overall-acceptance-rate/

select round(ifnull((select count(distinct concat(requester_id,',',accepter_id)) from request_accepted)/
(select count(distinct concat(sender_id,',',send_to_id)) from friend_request),0),2) as accept_rate

follow-up
1.Can you write a query to return the accept rate but for every month?

with a as 
(select left(request_date,7) as month, count(distinct concat(sender_id, ',', send_to_id)) as send 
 from friend_request
 group by 1
), 
b as  
(select left(accept_date,7) as month, count(distinct concat(requester_id, ',', accepter_id)) as accept
 from request_accepted
 group by 1
)
select a.month, round(ifnull(b.accept/a.send,0),2) as monthly_rate
from a join b on a.month = b.month

2.How about the cumulative accept rate for every day?
## sum up the case when ind is 'a', which means it belongs to accept table, divided by sum of ind is 'r', which means it belong to request table
select s.date1, ifnull(round(sum(case when t.ind = 'a' then t.cnt else 0 end)/sum(case when t.ind = 'r' then t.cnt else 0 end),2),0) 
from
## get a table of all unique dates
(select distinct x.request_date as date1 from friend_request x
## The reason here use union sicne we don't want duplicate date
union 
 select distinct y.accept_date as date1 from request_accepted y 
) s
## left join to make sure all dates are in the final output
left join 
## get a table of all dates, count of each days, ind to indicate which table it comes from
(select v.request_date as date1, count(*) as cnt,'r' as ind from friend_request v group by v.request_date
## The reason here use union all sicne union all will be faster
union all
select w.accept_date as date1, count(*) as cnt,'a' as ind from request_accepted w group by w.accept_date) t
## s.date1 >= t.date1, which for each reacord in s, it will join with all records earlier than it in t
on s.date1 >= t.date1
# group by s.date1 then we can get a cumulative result to that day
group by s.date1
order by s.date1
;

601. Human Traffic of Stadium
https://leetcode.com/problems/human-traffic-of-stadium/

select cte.id, cte.visit_date, cte.people
from
(SELECT ID
        , visit_date
        , people
        , LEAD(people, 1) OVER (ORDER BY id) nxt
        , LEAD(people, 2) OVER (ORDER BY id) nxt2
        , LAG(people, 1) OVER (ORDER BY id) pre
        , LAG(people, 2) OVER (ORDER BY id) pre2
    FROM Stadium
) as cte
where (cte.people >=100 and cte.nxt>=100 and cte.nxt2>=100)
or (cte.people >=100 and cte.nxt>=100 and cte.pre>=100)
or (cte.people >=100 and cte.pre>=100 and cte.pre2>=100)

602. Friend Requests II: Who Has the Most Friends
https://leetcode.com/problems/friend-requests-ii-who-has-the-most-friends/

select b.id, b.num
from 
(select a.requester_id as id, count(*) as num, dense_rank() over(order by count(*) desc) as rnk
from
(
(select requester_id, accepter_id from request_accepted)
union
(select accepter_id, requester_id from request_accepted)
) a
group by a.requester_id) b
where b.rnk=1

603. Consecutive Available Seats
https://leetcode.com/problems/consecutive-available-seats/

select a.seat_id
from
(select seat_id, 
free, 
lead(free,1) over(order by seat_id) nxt, 
lag(free,1) over(order by seat_id) pre
from cinema) a
where (a.free=1 and a.nxt=1)
or (a.pre=1 and a.free=1)
order by a.seat_id

607. Sales Person
https://leetcode.com/problems/sales-person/

select name from salesperson
where sales_id
not in
(select sales_id
from orders
where com_id
in
(select com_id from company where name = 'RED'))

608. Tree Node
https://leetcode.com/problems/tree-node/

select distinct t1.id,
(case when t1.p_id is null then 'Root' 
 when t2.p_id is not null then 'Inner'
 when t2.p_id is null and t2.id is null then 'Leaf' end) as type
from tree t1
left join tree t2
on t1.id = t2.p_id

610. Triangle Judgement
https://leetcode.com/problems/triangle-judgement/

select *, case when x+y > z and y+z > x and x+z > y then 'Yes' else 'No' end as triangle
from triangle

612. Shortest Distance in a Plane
https://leetcode.com/problems/shortest-distance-in-a-plane/submissions/

select round(sqrt(pow(p1.x - p2.x,2) + pow(p1.y - p2.y,2)),2) as shortest
from point_2d p1, point_2d p2
where p1.x != p2.x or p1.y != p2.y
order by 1 limit 1

613. Shortest Distance in a Line
https://leetcode.com/problems/shortest-distance-in-a-line/

select min(abs(p1.x-p2.x)) as shortest
from point p1, point p2
where p1.x != p2.x

614. Second Degree Follower
https://leetcode.com/problems/second-degree-follower/

select f1.follower as follower, count( distinct f2.follower) as num
from follow f1 join follow f2 
on f1.follower = f2.followee
group by f1.follower
order by f1.follower

615. Average Salary: Departments VS Company
https://leetcode.com/problems/average-salary-departments-vs-company/

with a as 
(
select left(s.pay_date,7) as pay_month, e.department_id, avg(s.amount) as avg_sa  
    from salary s join employee e
    on s.employee_id = e.employee_id
    group by 1, 2 
),

b as 
(
select left(s.pay_date,7) as pay_month, avg(s.amount) as avg_sa
    from salary s
    group by 1
)

select a.pay_month, a.department_id, 
(case when a.avg_sa > b.avg_sa then 'higher' 
 when  a.avg_sa = b.avg_sa then 'same'
 else 'lower' end) as comparison
from a join b 
on a.pay_month = b.pay_month

618. Students Report By Geography
https://leetcode.com/problems/students-report-by-geography/

select max(case when continent = 'America' then name end) as 'America',
    max(case when continent = 'Asia' then name end) as 'Asia',
    max(case when continent = 'Europe' then name end) as 'Europe'
from 
(select *, row_number() over(partition by continent order by name) as row_id from student) a
group by a.row_id

619. Biggest Single Number
https://leetcode.com/problems/biggest-single-number/

select (select num
from my_numbers
group by num
having count(*) = 1
order by num desc limit 1) as num

620. Not Boring Movies
https://leetcode.com/problems/not-boring-movies/

select * 
from cinema
where id % 2 = 1 and description not like "boring"
order by rating desc

626. Exchange Seats
https://leetcode.com/problems/exchange-seats/

select (case when id %2 = 1 and id = (select max(id) from seat) then id
        when id % 2 = 1 then id+1 
        when id % 2 =0 then id-1 end) as id, 
        student
from seat
order by id

627. Swap Salary
https://leetcode.com/problems/swap-salary/

update salary
set sex = (case when sex = 'f' then 'm' else 'f' end)

1045. Customers Who Bought All Products
https://leetcode.com/problems/customers-who-bought-all-products/

select customer_id
from customer
group by customer_id
having count(distinct product_key) = 
(select count(distinct product_key) from product)

1050. Actors and Directors Who Cooperated At Least Three Times
https://leetcode.com/problems/actors-and-directors-who-cooperated-at-least-three-times/

select actor_id, director_id
from ActorDirector
group by actor_id, director_id
having count(*)>=3

1068. Product Sales Analysis I
https://leetcode.com/problems/product-sales-analysis-i/

SELECT p.product_name, s.year, s.price
FROM product p inner join sales s
ON p.product_id = s.product_id

1069. Product Sales Analysis II
https://leetcode.com/problems/product-sales-analysis-ii/

SELECT product_id, sum(quantity) as total_quantity
FROM sales
GROUP BY product_id

1070. Product Sales Analysis III
https://leetcode.com/problems/product-sales-analysis-iii/

SELECT product_id, 
year as first_year,
quantity,
price
FROM 
(SELECT *, rank() over(partition by product_id order by year) as rnk
FROM sales) a
where rnk=1

1075. Project Employees I
https://leetcode.com/problems/project-employees-i/

SELECT p.project_id, round(avg(e.experience_years),2) as average_years
FROM project p join employee e
ON p.employee_id = e.employee_id
GROUP BY p.project_id

1076. Project Employees II
https://leetcode.com/problems/project-employees-ii/

SELECT project_id
FROM project
GROUP BY project_id
HAVING COUNT(employee_id) =
(
    SELECT count(employee_id)
    FROM project
    GROUP BY project_id
    ORDER BY count(employee_id) desc
    LIMIT 1
)

1077. Project Employees III
https://leetcode.com/problems/project-employees-iii/

SELECT project_id, employee_id
FROM
(SELECT p.project_id, e.employee_id, rank() over(partition by p.project_id order by e.experience_years desc) as rnk  
FROM project p join employee e
on p.employee_id = e.employee_id) a
WHERE rnk=1

1082. Sales Analysis I
https://leetcode.com/problems/sales-analysis-i/

SELECT seller_id
FROM sales
GROUP BY seller_id
HAVING sum(price)=
(SELECT sum(price) as sp
FROM sales
GROUP BY seller_id
ORDER BY 1 DESC
limit 1)

1083. Sales Analysis II
https://leetcode.com/problems/sales-analysis-ii/

SELECT s.buyer_id
FROM sales s join product p
ON s.product_id = p.product_id 
GROUP BY s.buyer_id
having sum(case when p.product_name = 'S8' then 1 else 0 end)>0
and sum(case when p.product_name = 'Iphone' then 1 else 0 end)=0

1084. Sales Analysis III
https://leetcode.com/problems/sales-analysis-iii/

SELECT p.product_id, p.product_name
from product p join sales s
ON p.product_id = s.product_id
group by p.product_id, p.product_name
having min(sale_date) >= '2019-01-01' and max(sale_date) <='2019-03-31'

1097. Game Play Analysis V
https://leetcode.com/problems/game-play-analysis-v/submissions/
select a1.first_login as install_dt, count(distinct a1.player_id) installs, round(sum(case when a2.event_date is not null then 1 else 0 end) / count(distinct a1.player_id) ,2) Day1_retention  
from
(select player_id, min(event_date) first_login from activity group by player_id) a1 
left join activity a2 
on a1.player_id = a2.player_id and a1.first_login + 1 = a2.event_date
group by install_dt

1098. Unpopular Books
https://leetcode.com/problems/unpopular-books/

SELECT b.book_id, b.name
FROM 
    (SELECT book_id, sum(quantity) as bs
    FROM orders
    where dispatch_date <= '2019-06-23' and dispatch_date >= '2018-06-23'
    GROUP BY book_id) a 
RIGHT JOIN books b
ON a.book_id = b.book_id
WHERE (a.bs <10 or a.bs is null) AND b.available_from <'2019-05-23'

1107. New Users Daily Count
https://leetcode.com/problems/new-users-daily-count/

SELECT ml as login_date, count(distinct user_id) as user_count
FROM
(
    SELECT user_id, min(activity_date) as ml
    FROM Traffic
    WHERE activity ='login'
    GROUP BY user_id
    ) a
where ml >= '2019-04-01'
group by ml

1112. Highest Grade For Each Student
https://leetcode.com/problems/highest-grade-for-each-student/

SELECT e.student_id, min(e.course_id) as course_id, e.grade
FROM
    (
    SELECT student_id, max(grade) as mg
    FROM Enrollments
    GROUP BY student_id
    ) a
JOIN Enrollments e
ON a.student_id = e.student_id AND a.mg = e.grade
GROUP BY e.student_id, e.grade
ORDER BY e.student_id

1113. Reported Posts
https://leetcode.com/problems/reported-posts/

select 
  extra as report_reason
  ,count(distinct post_id) as report_count
from Actions
where action_date = '2019-07-04'
  and action = 'report'
group by extra

1126. Active Businesses
https://leetcode.com/problems/active-businesses/

SELECT b.business_id
FROM

    (SELECT event_type, avg(occurences) as ao
    FROM events
    GROUP BY event_type) a
join events b
on a.event_type = b.event_type
GROUP BY b.business_id
HAVING (sum(case when b.occurences > a.ao then 1 else 0 end))>1

1127. User Purchase Platform
https://leetcode.com/problems/user-purchase-platform/

with a as 
(
select spend_date, 
    user_id,
    sum(case when platform='mobile' then amount else 0 end) as mobile_amount,
    sum(case when platform='desktop' then amount else 0 end) as desktop_amount
    from spending
    group by spend_date,user_id
),
b as 
(
select spend_date,
    user_id,
    if(mobile_amount>0,if(desktop_amount>0,'both','mobile'),'desktop') as platform,
    (mobile_amount+desktop_amount) as amount
    from a
),
c as 
(
select distinct spend_date, 'mobile' as platform from spending
    union
select distinct spend_date, 'desktop' as platform from spending
    union
select distinct spend_date, 'both' as platform from spending
)

select c.spend_date, 
        c.platform,
        ifnull(sum(b.amount),0) as total_amount,
        count(b.user_id) as total_users
from
c left join b
on b.spend_date = c.spend_date and b.platform=c.platform
group by c.spend_date,c.platform

1132. Reported Posts II
https://leetcode.com/problems/reported-posts-ii/

select round(sum(percent)/count(distinct action_date),2) as average_daily_percent
from
    (select a.action_date,
    count(distinct r.post_id)/count(distinct a.post_id)*100 as percent
    from actions a left join removals r
    on a.post_id = r.post_id
    where a.extra='spam'
    group by 1) temp;

1141. User Activity for the Past 30 Days I
https://leetcode.com/problems/user-activity-for-the-past-30-days-i/

SELECT activity_date as day, count(distinct user_id) as active_users
FROM Activity
WHERE activity_date >= '2019-06-28'
AND activity_date <= '2019-07-27'
GROUP BY activity_date

1142. User Activity for the Past 30 Days II
https://leetcode.com/problems/user-activity-for-the-past-30-days-ii/

SELECT ifnull(round(count(distinct session_id)/count(distinct user_id),2),0) as average_sessions_per_user
FROM Activity
WHERE activity_date >= '2019-06-28'
AND activity_date <= '2019-07-27'

1148. Article Views I
https://leetcode.com/problems/article-views-i/

select  distinct viewer_id as id
from views
where author_id=viewer_id
order by id

1149. Article Views II
https://leetcode.com/problems/article-views-ii/

select distinct viewer_id as id
from views
group by view_date, viewer_id
having count(distinct article_id) > 1
order by id

1158. Market Analysis I
https://leetcode.com/problems/market-analysis-i/

select u.user_id as buyer_id, u.join_date, ifnull(count(o.order_id),0) as orders_in_2019
from (select * from orders where year(order_date)='2019') o 
right join users u
on o.buyer_id = u.user_id
group by u.user_id

1159. Market Analysis II
https://leetcode.com/problems/market-analysis-ii/

select u.user_id as seller_id, case when u.favorite_brand = b.item_brand then 'yes' else 'no' end as 2nd_item_fav_brand
from
    users u
left join 
    (select a.seller_id, i.item_brand
    from
    (select seller_id,item_id, rank() over(partition by seller_id order by order_date) rnk
    from orders) a
     join items i on i.item_id = a.item_id
where a.rnk=2) b
on u.user_id = b.seller_id

1164. Product Price at a Given Date
https://leetcode.com/problems/product-price-at-a-given-date/

with a as 
(select product_id, new_price from products
where (product_id, change_date)
in
(select product_id, max(change_date) 
from products
where change_date <= '2019-08-16'
group by product_id))

select temp.product_id, case when a.new_price is null then 10 else a.new_price end as price
from
(select distinct product_id from products) temp
left join 
a
on temp.product_id = a.product_id

1173. Immediate Food Delivery I
https://leetcode.com/problems/immediate-food-delivery-i/

select round(sum(case when order_date = customer_pref_delivery_date then 1  else 0 end)/count(*)*100.0,2) as immediate_percentage
from delivery

1174. Immediate Food Delivery II
https://leetcode.com/problems/immediate-food-delivery-ii/

with a as 
(select customer_id, min(order_date) as mo
from delivery
group by customer_id)

select round(sum(case when d.customer_pref_delivery_date=a.mo then 1 else 0 end)/count(distinct d.customer_id)*100,2) as immediate_percentage
from
(select distinct customer_id, customer_pref_delivery_date
from delivery) d join a
on d.customer_id = a.customer_id

1179. Reformat Department Table
https://leetcode.com/problems/reformat-department-table/

select id, 
sum(case when month ='Jan' then revenue else null end) as Jan_revenue,
sum(case when month ='Feb' then revenue else null end) as Feb_revenue,
sum(case when month ='Mar' then revenue else null end) as Mar_revenue,
sum(case when month ='Apr' then revenue else null end) as Apr_revenue,
sum(case when month ='May' then revenue else null end) as May_revenue,
sum(case when month ='Jun' then revenue else null end) as Jun_revenue,
sum(case when month ='Jul' then revenue else null end) as Jul_revenue,
sum(case when month ='Aug' then revenue else null end) as Aug_revenue,
sum(case when month ='Sep' then revenue else null end) as Sep_revenue,
sum(case when month ='Oct' then revenue else null end) as Oct_revenue,
sum(case when month ='Nov' then revenue else null end) as Nov_revenue,
sum(case when month ='Dec' then revenue else null end) as Dec_revenue
from department
group by id
order by id

1193. Monthly Transactions I
https://leetcode.com/problems/monthly-transactions-i/

select left(trans_date,7) as month,
country,
count(id) as trans_count,
sum(case when state='approved' then 1 else 0 end) as approved_count,
sum(amount) as trans_total_amount,
sum(case when state='approved' then amount else 0 end) as approved_total_amount
from transactions
group by 1,2

1194. Tournament Winners
https://leetcode.com/problems/tournament-winners/

with scores as 
((select first_player as player_id, first_score as score from matches)
union all 
(select second_player as player_id, second_score as score from matches)),
b as
(select player_id, sum(score) as score
from scores
group by player_id),
c as 
(select p.group_id, p.player_id, rank() over(partition by p.group_id order by b.score desc, p.player_id) as rnk
from players p join b 
on p.player_id = b.player_id)

select group_id, player_id
from c
where rnk=1

1204. Last Person to Fit in the Elevator
https://leetcode.com/problems/last-person-to-fit-in-the-elevator/

SELECT q1.person_name
FROM Queue q1 JOIN Queue q2 ON q1.turn >= q2.turn
GROUP BY q1.turn
HAVING SUM(q2.weight) <= 1000
ORDER BY SUM(q2.weight) DESC
LIMIT 1

1205. Monthly Transactions II
https://leetcode.com/problems/monthly-transactions-ii/

with a as 
(
(select left(trans_date,7) as month, country, state, amount from transactions
    where state='approved')
union all    
(select left(c.trans_date, 7) as month, t.country, 'back' as state, t.amount
    from Chargebacks c join Transactions t
 on c.trans_id = t.id
)
)
select a.month,  
        a.country,
        sum(case when a.state='approved' then 1 else 0 end) as approved_count,
        sum(case when a.state='approved' then a.amount else 0 end) as approved_amount,
        sum(case when a.state='back' then 1 else 0 end) as chargeback_count,
        sum(case when a.state='back' then a.amount else 0 end)
        as chargeback_amount
from
a
group by 1,2

1211. Queries Quality and Percentage
https://leetcode.com/problems/queries-quality-and-percentage/

select query_name, 
        round(avg(quality),2) as quality,
        round(sum(poor_query)/count(*)*100.0,2) as poor_query_percentage
from
    (select query_name,
            (rating/position) as quality,
            case when rating < 3 then 1 else 0 end as poor_query
    from Queries) a
group by query_name

1212. Team Scores in Football Tournament
https://leetcode.com/problems/team-scores-in-football-tournament/

with a as
((select host_team, guest_team, host_goals, guest_goals
from matches)
union all 
(select guest_team, host_team, guest_goals, host_goals
from matches)),
b as 
(
select host_team, 
    case when host_goals>guest_goals then 3 
    when host_goals=guest_goals then 1 
    else 0 end as score
from a
),
c as 
(
select host_team as team_id, sum(score) as score
from b
group by host_team
)

select t.team_id, t.team_name, ifnull(c.score,0) as num_points
from teams t left join c
on t.team_id = c.team_id
order by num_points desc, t.team_id

1225. Report Contiguous Dates
https://leetcode.com/problems/report-contiguous-dates/

with a as
(
(select fail_date as day, 'failed' as stats, rank() over(order by fail_date) as rk
from failed where fail_date between '2019-01-01' and '2019-12-31')
union 
(select success_date as day, 'succeeded' as stats, rank() over(order by success_date) as rk
from Succeeded where success_date between '2019-01-01' and '2019-12-31')
),

b as 
(
select day, stats, (rank() over(order by day) - rk) int_1
from a
)

select stats as period_state, min(day) as start_date, max(day) end_date
from b
group by int_1, stats
order by start_date

1241. Number of Comments per Post
https://leetcode.com/problems/number-of-comments-per-post/

select s1.sub_id as post_id,
    count(distinct s2.sub_id) as number_of_comments
from submissions s1
left join submissions s2
on s1.sub_id = s2.parent_id
where s1.parent_id is null
group by s1.sub_id

1251. Average Selling Price
https://leetcode.com/problems/average-selling-price/

select u.product_id, 
        round(sum(p.price * u.units)/sum(u.units),2) as average_price
from prices p
join unitssold u
on p.product_id = u.product_id
and (u.purchase_date between p.start_date and p.end_date)
group by u.product_id

1264. Page Recommendations
https://leetcode.com/problems/page-recommendations/



1270. All People Report to the Given Manager
https://leetcode.com/problems/all-people-report-to-the-given-manager/



1280. Students and Examinations
https://leetcode.com/problems/students-and-examinations/



1445. Apples & Oranges
https://leetcode.com/problems/apples-oranges/

select sale_date, sum(case when fruit='apples' then sold_num else -sold_num end) as diff
from sales
group by sale_date

1454. Active Users
https://leetcode.com/problems/active-users/

select distinct l1.id, a.name
from
logins l1 join logins l2
on l1.id = l2.id and datediff(l1.login_date, l2.login_date) between 1 and 4
join accounts a 
on l1.id = a.id
group by l1.id, l1.login_date
having count(distinct l2.login_date)=4 

1459. Rectangles Area
https://leetcode.com/problems/rectangles-area/

SELECT  pt1.id as P1, pt2.id as P2,
		ABS(pt1.x_value - pt2.x_value)*ABS(pt1.y_value-pt2.y_value) as AREA
FROM Points pt1 JOIN Points pt2 
ON pt1.id<pt2.id
AND pt1.x_value!=pt2.x_value 
AND pt2.y_value!=pt1.y_value
ORDER BY AREA DESC, p1, p2

1468. Calculate Salaries
https://leetcode.com/problems/calculate-salaries/

select b.company_id, 
b.employee_id, 
b.employee_name, 
round(b.salary*(1-a.rate)) as salary
from 
(select company_id, 
case when max(salary)> 10000 then 0.49
when max(salary)>= 1000 and max(salary)<= 10000 then 0.24 else 0 end as rate
from salaries
group by company_id) a
join salaries b 
on a.company_id = b.company_id


1479. Sales by Day of the Week
https://leetcode.com/problems/sales-by-day-of-the-week/

select i.item_category as Category,
sum(case when dayofweek(o.order_date)=2 then quantity else 0 end) as 'Monday',
sum(case when dayofweek(o.order_date)=3 then quantity else 0 end) as 'Tuesday',
sum(case when dayofweek(o.order_date)=4 then quantity else 0 end) as 'Wednesday',
sum(case when dayofweek(o.order_date)=5 then quantity else 0 end) as 'Thursday',
sum(case when dayofweek(o.order_date)=6 then quantity else 0 end) as 'Friday',
sum(case when dayofweek(o.order_date)=7 then quantity else 0 end) as 'Saturday',
sum(case when dayofweek(o.order_date)=1 then quantity else 0 end) as 'Sunday'
from items i left join
orders o
on i.item_id = o.item_id
group by i.item_category
order by i.item_category

1484. Group Sold Products By The Date
https://leetcode.com/problems/group-sold-products-by-the-date/

select sell_date, 
count( distinct product) as num_sold, 
GROUP_CONCAT(DISTINCT product ORDER BY product ASC SEPARATOR ',') AS products
from Activities
group by sell_date
order by sell_date

1495. Friendly Movies Streamed Last Month
https://leetcode.com/problems/friendly-movies-streamed-last-month/

select distinct c.title
from TVProgram t
join content c
on t.content_id = c.content_id
where c.kids_content='Y'
and c.content_type='Movies'
and left(t.program_date,7)='2020-06'

1501. Countries You Can Safely Invest In
https://leetcode.com/problems/countries-you-can-safely-invest-in/

select con.name as country
from person p join calls c
on p.id = c.caller_id or p.id = c.callee_id
join country con 
on left(p.phone_number,3) = con.country_code
group by con.name
having avg(c.duration) >(select avg(duration) from calls)

1511. Customer Order Frequency
https://leetcode.com/problems/customer-order-frequency/

select customer_id, name
from customers join orders using(customer_id)
join product using(product_id)
group by customer_id
having sum(if(left(order_date,7)='2020-06',quantity, 0)*price)>=100 and
sum(if(left(order_date,7)='2020-07',quantity, 0)*price)>=100

1517. Find Users With Valid E-Mails
https://leetcode.com/problems/find-users-with-valid-e-mails/

SELECT *
FROM Users
WHERE REGEXP_LIKE(mail,'^[A-Za-z][A-Za-z0-9\_\.\-]*@leetcode\.com$')

1527. Patients With a Condition
https://leetcode.com/problems/patients-with-a-condition/

select patient_id, patient_name, conditions
from patients
where conditions like '%DIAB1%'

1532. The Most Recent Three Orders
https://leetcode.com/problems/the-most-recent-three-orders/

select c.name as customer_name,
                c.customer_id,
                o.order_id,
                o.order_date
from 
(select customer_id, order_id, order_date,
RANK() over (PARTITION by customer_id order by order_date desc) as rnk
from orders) o
join customers c
on o.customer_id=c.customer_id
where o.rnk <=3
order by c.name, c.customer_id, o.order_date desc

1543. Fix Product Name Format
https://leetcode.com/problems/fix-product-name-format/

select lower(replace(product_name,' ','')) as product_name, 
left(sale_date,7) as sale_date, 
count(sale_id) as total
from sales
group by 1,2
order by 1,2

1549. The Most Recent Orders for Each Product
https://leetcode.com/problems/the-most-recent-orders-for-each-product/

select p.product_name, p.product_id, o.order_id, o.order_date
from orders o
join products p
on o.product_id = p.product_id
where (o.product_id, o.order_date) 
in 
(select product_id, max(order_date) md
from orders
group by product_id)
order by p.product_name, p.product_id, o.order_id

1555. Bank Account Summary
https://leetcode.com/problems/bank-account-summary/

select u.user_id,
        u.user_name,
        (u.credit - ifnull(out_tmp.bal_out,0)+ifnull(in_tmp.bal_in,0)) as credit,
        if((u.credit-ifnull(out_tmp.bal_out,0)+ifnull(in_tmp.bal_in,0))>0,'No','Yes') as credit_limit_breached
from users u
left join 
    (select paid_by, 
            sum(amount) as bal_out
    from Transactions
    group by paid_by) out_tmp
on u.user_id = out_tmp.paid_by
left join
    (select paid_to, 
            sum(amount) as bal_in
    from Transactions
    group by paid_to) in_tmp
on u.user_id = in_tmp.paid_to


1565. Unique Orders and Customers Per Month
https://leetcode.com/problems/unique-orders-and-customers-per-month/

select left(order_date,7) as month, 
count(distinct order_id) as order_count, 
count(distinct customer_id) as customer_count
from
orders
where invoice > 20
group by 1

1571. Warehouse Manager
https://leetcode.com/problems/warehouse-manager/

select w.name as warehouse_name, 
sum(w.units*pn.volume) as volume
from warehouse w
join 
(select product_id, product_name, width*length*height as volume
from products) pn
on w.product_id = pn.product_id
group by w.name

1581. Customer Who Visited but Did Not Make Any Transactions
https://leetcode.com/problems/customer-who-visited-but-did-not-make-any-transactions/

select v.customer_id, sum(if(amount is null, 1,0)) as count_no_trans
from visits v left join
transactions t
on v.visit_id = t.visit_id
group by v.customer_id
having sum(if(amount is null, 1,0))>0

1587. Bank Account Summary II
https://leetcode.com/problems/bank-account-summary-ii/

select u.name, sum(t.amount) as balance
from users u 
join transactions t
on u.account= t.account
group by u.account
having sum(t.amount)>10000

1596. The Most Frequently Ordered Products for Each Customer
https://leetcode.com/problems/the-most-frequently-ordered-products-for-each-customer/

SELECT customer_id, product_id, product_name
FROM (
    SELECT O.customer_id, O.product_id, P.product_name, 
    RANK() OVER (PARTITION BY customer_id ORDER BY COUNT(O.product_id) DESC) AS rnk
    FROM Orders O
    JOIN Products P
    ON O.product_id = P.product_id  
    GROUP BY customer_id, product_id
) temp
WHERE rnk = 1 
ORDER BY customer_id, product_id

1607. Sellers With No Sales
https://leetcode.com/problems/sellers-with-no-sales/

select s.seller_name
from 
(select seller_id from orders 
 where sale_date <= '2020-12-31' 
 and sale_date >= '2020-01-01') o 
right join seller s
on o.seller_id = s.seller_id
where o.seller_id is null
order by s.seller_name

1613. Find the Missing IDs
https://leetcode.com/problems/find-the-missing-ids/

with recursive id_seq as 
(select 1 as continue_id 
union select continue_id+1
from id_seq where continue_id < 
(select max(customer_id) from customers))
select continue_id as ids
from id_seq
where continue_id not in (select customer_id from customers)

1623. All Valid Triplets That Can Represent a Country
https://leetcode.com/problems/all-valid-triplets-that-can-represent-a-country/

select sa.student_name as member_A, 
sb.student_name as member_B, 
sc.student_name as member_C
from SchoolA sa cross join SchoolB sb
cross join SchoolC sc
where sa.student_id != sb.student_id
and sb.student_id != sc.student_id
and sa.student_id != sc.student_id
and sa.student_name != sb.student_name
and sb.student_name != sc.student_name
and sa.student_name != sc.student_name

1633. Percentage of Users Attended a Contest
https://leetcode.com/problems/percentage-of-users-attended-a-contest/

select r.contest_id, 
round(count(distinct r.user_id)/(select count(distinct user_id) from users)*100,2) as percentage
from users u right join register r 
on u.user_id = r.user_id
group by r.contest_id
order by percentage desc, contest_id 
